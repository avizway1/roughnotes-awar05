sudo dnf update -y

sudo dnf install -y \
  java-17-amazon-corretto-devel \
  wget \
  unzip


dnf install -y postgresql15 postgresql15-server
/usr/bin/postgresql-setup --initdb
systemctl enable --now postgresql
systemctl status postgresql

# Kernel params for Elasticsearch

cat <<EOF >> /etc/sysctl.d/99-sonarqube.conf
vm.max_map_count=262144
fs.file-max=65536
EOF

sysctl --system

# File descriptor and process limits for sonar user
cat <<EOF >> /etc/security/limits.conf
sonar   -   nofile  65536
sonar   -   nproc   4096
EOF


# Replace StrongPassw0rd! with your own strong password
sudo -u postgres psql -c "CREATE USER sonar WITH PASSWORD 'StrongPassw0rd';"
sudo -u postgres psql -c "CREATE DATABASE sonarqube OWNER sonar;"


cd /opt

# Download SonarQube
wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-25.11.0.114957.zip

# Unzip and rename
unzip sonarqube-25.11.0.114957.zip
mv sonarqube-25.11.0.114957 sonarqube

# Create dedicated user and set ownership
useradd -r -s /bin/false sonar
chown -R sonar:sonar /opt/sonarqube


vim /opt/sonarqube/conf/sonar.properties

---
# Database config
sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube
sonar.jdbc.username=sonar
sonar.jdbc.password=StrongPassw0rd

# Listen on all interfaces (optional but useful on EC2)
sonar.web.host=0.0.0.0
sonar.web.port=9000
---

#Systemd Service for SonarQube

cat <<'EOF' > /etc/systemd/system/sonarqube.service
[Unit]
Description=SonarQube service
After=network.target postgresql.service

[Service]
Type=forking
User=sonar
Group=sonar
ExecStart=/opt/sonarqube/bin/linux-x86-64/sonar.sh start
ExecStop=/opt/sonarqube/bin/linux-x86-64/sonar.sh stop
Restart=on-failure
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
EOF


---

systemctl daemon-reload
systemctl enable --now sonarqube
systemctl status sonarqube







